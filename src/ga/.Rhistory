x1 = d1$x;
y1 = d1$y;
for (d2 in depositos){
x2 = d2$x;
y2 = d2$y;
distance = sqrt((x1 - x2)^2 + (y1-y2)^2);
auxiliarDepositos[i,j] = distance;
auxiliarDepositos[j,i] = distance;
auxiliarPlot[nr_clientes + i, nr_clientes + j] = distance;
auxiliarPlot[nr_clientes + j, nr_clientes + i] = distance;
j = j+1;
}
j=1
i = i+1;
}
#auxiliarPlot[nr_clientes:nrow(auxiliarPlot), nr_clientes:nrow(auxiliarPlot)]
remove(i,j, x1, x2, y1, y2, distance, c, c1, c2, d, d1, d2, depot)
remove(clientes, depositos, json)
library(GA)
library(permute)
cli_Dist = as.matrix(customerDistances);
cli_Demand = as.matrix(customerDemand, nrow=1);
cli_Depots_Dist = as.matrix(depositosDistances);
nr_clientes = ncol(cli_Demand)
nr_depositos = ncol(depositosStock)
nr_camioes = round(sum(cli_Demand) / vehicle_cap, 0)
# Fun??o para calcular o custo por kms percorrido num dado percurso
custo_viagem <- function(depositosDistances, customerDistances, percurso, deposito){
custo = 0
# Inicio: custo do deposito i ao 1? cliente visitado
custo = custo + depositosDistances[percurso[1], deposito]
# Rota: Calcular o custo por km percorrido na rota de 1 cami?o
percurso = c(percurso, percurso[1])
rota = embed(percurso, 2)[,2:1]
custo = custo + sum(customerDistances[rota])
# Regresso: custo de regressar do ?ltimo cliente ao deposito i
custo = custo + depositosDistances[percurso[length(percurso)], deposito]
return(custo)
}
#Function to calculate tour length
CustoTotal <- function(genoma, customerDistances, customerDemand, depositosDistances) {
# Cada cromossoma representa um deposito, que pode ou nao ser aberto
cromossomas = matrix(data=genoma, nrow=nr_depositos, ncol=nr_camioes*nr_clientes, byrow=TRUE);
# custo inicial da solu??o ? zero
custo = 0;
# vetor com a procura de cada client. No final, a soma deve ser zero (toda a procura satisfeita)
procura = cli_Demand
# Primeiro ciclo divide o genoma em cromossomas
# - Computar cada um dos depositos (cromossomas)
for(it_dep in c(1:nrow(cromossomas))){
# Teste inicial para saber se o deposito ? ou n?o aberto
# - Olha para os dados do deposito sem considerar as divis?es por cami?o
# - Fica apenas com os valores do cromossoma entre [1:nr_clientes]
# - Se length(deposito == 0) nenhum cami?o do deposito ? utilizado -> o deposito nao ? aberto
deposito = intersect(cromossomas[it_dep,], c(1:nr_clientes));
if(length(deposito)!=0){ # O deposito ? aberto -> ter? influencia no custo
# opening costs for the depots
custo = custo + depot_cost[it_dep]
# stock inicial do deposito
stock_atual = depositosStock[it_dep] #
# Dividir as infos do deposito por cada cami?o
deposito = matrix(data=cromossomas[it_dep,], nrow=nr_camioes, ncol=nr_clientes)
# Segundo ciclo divide o cromossoma em genes
# - Computar cada um dos cami?es (gene) do deposito i
for(it_cam in c(1:nrow(deposito))){
# Obter os alelos de um gene = clientes por onde passa o cami?o
camiao = matrix(data=deposito[it_cam,], nrow=1, ncol=nr_clientes);
# Ficar com o percurso efetivamente possivel de desempenhar por um cami?o
percurso = intersect(camiao, c(1:nr_clientes))
# Se length(percurso == 0) o cami?o n?o ? utilizado -> n?o tr?s custos
if(length(percurso!=0)){
# opening cost of a route (cost of a vehicle)
custo = custo + vehicle_cost
# Se 1 cami?o ? usado, o stock do deposito baixa
stock_atual = stock_atual - vehicle_cap
# Carga inicial do cami?o no inicio do percurso
carga_atual = vehicle_cap
for(cli in c(1:length(percurso))){
cliente = percurso[cli]
# sen?o, vamos satisfazer o m?ximo de procura do cliente
if(carga_atual >= procura[cliente]){
# s? se consideram entregas completas da procura do cliente
entregar = procura[cliente]
carga_atual = carga_atual - entregar; # reduzir capacidade disponivel do cami?o
procura[cliente] = 0 # reduzir a procura do cliente
}else{
# passamos por um cliente sem stock no cami?o para o atender
# aumentar absurdamente o custo da solu??o, para penalizar
custo = custo + 10000000000
}
}
# Calcular o custo de uma viagem
c_viagem <- custo_viagem(depositosDistances, customerDistances, percurso)
custo = custo + c_viagem
}
}
}
}
if(sum(procura)!=0){
return(custo = custo + 10000000000) # o genoma nao satisfaz a procura de todo os cliente
}else{
return(custo)
#custo
}
}
#Firness function to be minimized
tspFitness <- function(genoma, customerDistances, customerDemand, depositosDistances) {
1 / CustoTotal(genoma, customerDistances, customerDemand, depositosDistances)
}
sizeGenoma = nr_depositos * nr_camioes * nr_clientes
GA <- ga(type = "permutation", fitness = tspFitness,
customerDistances=customerDistances, customerDemand=customerDemand, depositosDistances=depositosDistances,
#nBits = nr_camioes*nr_clientes,
#population = ga_Population,
min = 1, max = sizeGenoma, popSize = 100,
maxiter = 500, run = 500,
pmutation = 0.3, pcrossover =0.2, elitism = 0.2)
summary(GA)
custo = 0
tours = GA@solution
for(g in c(1:nrow(tours))){
custo <- CustoTotal(genoma = tours[g,], customerDistances, customerDemand, depositosDistances)
cat("custo solu??o ", g, " = ", (custo), "\n" )
}
#Visualization
# Marcar clientes no mapa
mds <- cmdscale(cli_Dist)
x <- mds[, 1];    y <- mds[, 2];      n <- length(x)
plot(x,y, type="n", asp=1, xlab="", ylab="", main="Tour after GA converted")
points(x,y,pch=15, cex=1.5, col="blue")
abline(h = pretty(range(x), 10), v = pretty(range(y), 10), col="lightgrey")
# Marcar depositos no mapa
depot_Dist = auxiliarPlot[nr_clientes:nrow(auxiliarPlot),nr_clientes:nrow(auxiliarPlot)]
mds <- cmdscale(depot_Dist)
x <- mds[, 1];    y <- mds[, 2];      n <- length(x)
points(x,y,pch=17, cex=1.5, col="red")
#repor localiza?ao
mds <- cmdscale(cli_Dist)
x <- mds[, 1];    y <- mds[, 2];      n <- length(x)
# imprimir as rotas
cores_dep = c("chocolate1", "cornsilk1", "cyan4", "darkgoldenrod1", "darkolivegreen1", "darkmagenta", "darkgreen", "darkorchid2", "gold1", "gray33")
tours <- GA@solution[1, ]
cromossomas = matrix(data=tours, nrow=nr_depositos, ncol=nr_camioes*nr_clientes, byrow=TRUE);
for(it_dep in c(1:nrow(cromossomas))){
# Dividir as infos do deposito por cada cami?o
deposito = matrix(data=cromossomas[it_dep,], nrow=nr_camioes, ncol=nr_clientes)
for(it_cam in c(1:nrow(deposito))){
# Obter os alelos de um gene = clientes por onde passa o cami?o
camiao = matrix(data=deposito[it_cam,], nrow=1, ncol=nr_clientes);
# Ficar com o percurso efetivamente possivel de desempenhar por um cami?o
percurso = intersect(camiao, c(1:nr_clientes))
if(length(percurso)!=0){
tour = percurso
cat(percurso, "\n")
tour <- c(tour, tour[1]) # adicionar o regresso ao ponto partida
n <- length(tour)
arrows(x[tour[-n]], y[tour[-n]],x[tour[-1]], y[tour[-1]], length = 0.15, angle=45, col=cores_dep[it_dep], lwd=2)
text(x, y-100, labels(cli_Dist), cex=0.8)
}
}
}
#install.packages("rjson")
#install.packages("jsonlite")
library(GA)
library(jsonlite)
json <- fromJSON("~/Desktop/cn3/data/json/barreto_json/coordChrist50.json")
nr_clientes = json$meta_data$nb_customers
nr_depositos = json$meta_data$nb_depots
vehicle_cap = json$meta_data$vehicle_cap
vehicle_cost = json$meta_data$vehicle_cost
cost_type = json$meta_data$cost_type
clientes = json$customers
depositos = json$depots
customerDistances = matrix(nrow=nr_clientes, ncol = nr_clientes)
customerDemand = matrix(ncol=nr_clientes, nrow=1)
depositosDistances = matrix(nrow = nr_clientes, ncol = nr_depositos)
auxiliarDepositos = matrix(nrow = nr_depositos, ncol = nr_depositos)
auxiliarPlot = matrix(nrow = nr_clientes + nr_depositos, ncol = nr_clientes + nr_depositos)
depositosStock = matrix(ncol=nr_depositos, nrow=1)
depot_cost = matrix(ncol=nr_depositos, nrow=1)
#calculate clientes distances from c0 -> c49
i=1
cli_pos = matrix(nrow=nr_clientes, ncol=2, byrow = TRUE)
for(c1 in clientes){
cli_pos[i, 1] = c1$x
cli_pos[i, 2] = c1$y
i = i+1
}
i = 1
depot_pos = matrix(nrow=nr_depositos, ncol=2, byrow = TRUE)
for(depot in depositos){
depot
depositosStock[i] = depot$capacity
depot_cost[i] = depot$opening_cost
depot_pos[i,1] = depot$x
depot_pos[i,2] = depot$y
i = i+1
}
i=1
j=1
for (c1 in clientes){
x1 = c1$x;
y1 = c1$y;
customerDemand[i] = c1$demand;
for (c2 in clientes){
x2 = c2$x;
y2 = c2$y;
d = sqrt((x1 - x2)^2 + (y1-y2)^2);
customerDistances[i,j] = d;
customerDistances[j,i] = d;
auxiliarPlot[i,j] = d;
auxiliarPlot[j,i] = d;
j = j+1;
}
j=1
i = i+1;
}
i=1
j=1
for (c in clientes){
x1 = c$x;
y1 = c$y;
for (d in depositos){
x2 = d$x;
y2 = d$y;
distance = sqrt((x1 - x2)^2 + (y1-y2)^2);
depositosDistances[i,j] = distance;
auxiliarPlot[i, nr_clientes + j] = distance;
auxiliarPlot[nr_clientes + j,i] = distance;
j = j+1;
}
j=1
i = i+1;
}
i=1
j=1
for (d1 in depositos){
x1 = d1$x;
y1 = d1$y;
for (d2 in depositos){
x2 = d2$x;
y2 = d2$y;
distance = sqrt((x1 - x2)^2 + (y1-y2)^2);
auxiliarDepositos[i,j] = distance;
auxiliarDepositos[j,i] = distance;
auxiliarPlot[nr_clientes + i, nr_clientes + j] = distance;
auxiliarPlot[nr_clientes + j, nr_clientes + i] = distance;
j = j+1;
}
j=1
i = i+1;
}
#auxiliarPlot[nr_clientes:nrow(auxiliarPlot), nr_clientes:nrow(auxiliarPlot)]
remove(i,j, x1, x2, y1, y2, distance, c, c1, c2, d, d1, d2, depot)
remove(clientes, depositos, json)
fileNames <- Sys.glob("~/Desktop/cn3/data/json/barreto_json/*.csv")
print(fileNames)
fileNames <- Sys.glob("~/Desktop/cn3/data/json/barreto_json/")
print(fileNames)
folderName = '~/Desktop/cn3/data/json/barreto_json/'
files <- list.files(folderName, full.names=TRUE)
print(fileNames)
folderName = '~/Desktop/cn3/data/json/barreto_json/'
files <- list.files(folderName, full.names=TRUE)
print(files)
folderName = '~/Desktop/cn3/data/json/barreto_json/'
files <- list.files(folderName, full.names=TRUE)
files <- files[ grepl("\\.[json]$", files) ]
print(files)
folderName = '~/Desktop/cn3/data/json/barreto_json/'
files <- list.files(folderName, full.names=TRUE)
files <- files[ grepl("\\.[json]", files) ]
print(files)
folderName = '~/Desktop/cn3/data/json/barreto_json/'
files <- list.files(folderName, full.names=TRUE)
files <- files[ grepl("\\.[json]", files) ]
print(files)
for (i in 1:length(files)){
runForAll(files[i])
}
runForAll <- function(fileName) {
json <- fromJSON(fileName)
nr_clientes = json$meta_data$nb_customers
nr_depositos = json$meta_data$nb_depots
vehicle_cap = json$meta_data$vehicle_cap
vehicle_cost = json$meta_data$vehicle_cost
cost_type = json$meta_data$cost_type
clientes = json$customers
depositos = json$depots
customerDistances = matrix(nrow=nr_clientes, ncol = nr_clientes)
customerDemand = matrix(ncol=nr_clientes, nrow=1)
depositosDistances = matrix(nrow = nr_clientes, ncol = nr_depositos)
auxiliarDepositos = matrix(nrow = nr_depositos, ncol = nr_depositos)
auxiliarPlot = matrix(nrow = nr_clientes + nr_depositos, ncol = nr_clientes + nr_depositos)
depositosStock = matrix(ncol=nr_depositos, nrow=1)
depot_cost = matrix(ncol=nr_depositos, nrow=1)
#calculate clientes distances from c0 -> c49
i=1
cli_pos = matrix(nrow=nr_clientes, ncol=2, byrow = TRUE)
for(c1 in clientes){
cli_pos[i, 1] = c1$x
cli_pos[i, 2] = c1$y
i = i+1
}
i = 1
depot_pos = matrix(nrow=nr_depositos, ncol=2, byrow = TRUE)
for(depot in depositos){
depot
depositosStock[i] = depot$capacity
depot_cost[i] = depot$opening_cost
depot_pos[i,1] = depot$x
depot_pos[i,2] = depot$y
i = i+1
}
i=1
j=1
for (c1 in clientes){
x1 = c1$x;
y1 = c1$y;
customerDemand[i] = c1$demand;
for (c2 in clientes){
x2 = c2$x;
y2 = c2$y;
d = sqrt((x1 - x2)^2 + (y1-y2)^2);
customerDistances[i,j] = d;
customerDistances[j,i] = d;
auxiliarPlot[i,j] = d;
auxiliarPlot[j,i] = d;
j = j+1;
}
j=1
i = i+1;
}
i=1
j=1
for (c in clientes){
x1 = c$x;
y1 = c$y;
for (d in depositos){
x2 = d$x;
y2 = d$y;
distance = sqrt((x1 - x2)^2 + (y1-y2)^2);
depositosDistances[i,j] = distance;
auxiliarPlot[i, nr_clientes + j] = distance;
auxiliarPlot[nr_clientes + j,i] = distance;
j = j+1;
}
j=1
i = i+1;
}
i=1
j=1
for (d1 in depositos){
x1 = d1$x;
y1 = d1$y;
for (d2 in depositos){
x2 = d2$x;
y2 = d2$y;
distance = sqrt((x1 - x2)^2 + (y1-y2)^2);
auxiliarDepositos[i,j] = distance;
auxiliarDepositos[j,i] = distance;
auxiliarPlot[nr_clientes + i, nr_clientes + j] = distance;
auxiliarPlot[nr_clientes + j, nr_clientes + i] = distance;
j = j+1;
}
j=1
i = i+1;
}
#auxiliarPlot[nr_clientes:nrow(auxiliarPlot), nr_clientes:nrow(auxiliarPlot)]
remove(i,j, x1, x2, y1, y2, distance, c, c1, c2, d, d1, d2, depot)
remove(clientes, depositos, json)
}
for (i in 1:length(files)){
runForAll(files[i])
}
for (i in 1:length(files)){
print(files[i])
runForAll(files[i])
}
files <- list.files(folderName, full.names=TRUE)
files <- files[ grepl(".[json]", files) ]
print(files)
for (i in 1:length(files)){
print(files[i])
runForAll(files[i])
}
files <- list.files(folderName, full.names=TRUE)
files <- list.files(folderName, full.names=TRUE)
print(files)
files <- files[ grepl("\\.[rR]$", files) ]
print(files)
files <- list.files(folderName, full.names=TRUE)
print(files)
files <- files[ grepl("\\.[json]$", files) ]
files <- list.files(folderName, full.names=TRUE)
files <- files[ grepl("\\.[json]", files) ]
print(files)
print(files[i])
runForAll(files[1])
print(files[1])
runForAll(files[1])
runForAll <- function(fileName) {
print(fileName)
json <- fromJSON(fileName)
print(json)
nr_clientes = json$meta_data$nb_customers
print(nr_clientes)
nr_depositos = json$meta_data$nb_depots
vehicle_cap = json$meta_data$vehicle_cap
vehicle_cost = json$meta_data$vehicle_cost
cost_type = json$meta_data$cost_type
clientes = json$customers
depositos = json$depots
customerDistances = matrix(nrow=nr_clientes, ncol = nr_clientes)
customerDemand = matrix(ncol=nr_clientes, nrow=1)
depositosDistances = matrix(nrow = nr_clientes, ncol = nr_depositos)
auxiliarDepositos = matrix(nrow = nr_depositos, ncol = nr_depositos)
auxiliarPlot = matrix(nrow = nr_clientes + nr_depositos, ncol = nr_clientes + nr_depositos)
depositosStock = matrix(ncol=nr_depositos, nrow=1)
depot_cost = matrix(ncol=nr_depositos, nrow=1)
#calculate clientes distances from c0 -> c49
i=1
cli_pos = matrix(nrow=nr_clientes, ncol=2, byrow = TRUE)
for(c1 in clientes){
cli_pos[i, 1] = c1$x
cli_pos[i, 2] = c1$y
i = i+1
}
i = 1
depot_pos = matrix(nrow=nr_depositos, ncol=2, byrow = TRUE)
for(depot in depositos){
depot
depositosStock[i] = depot$capacity
depot_cost[i] = depot$opening_cost
depot_pos[i,1] = depot$x
depot_pos[i,2] = depot$y
i = i+1
}
i=1
j=1
for (c1 in clientes){
x1 = c1$x;
y1 = c1$y;
customerDemand[i] = c1$demand;
for (c2 in clientes){
x2 = c2$x;
y2 = c2$y;
d = sqrt((x1 - x2)^2 + (y1-y2)^2);
customerDistances[i,j] = d;
customerDistances[j,i] = d;
auxiliarPlot[i,j] = d;
auxiliarPlot[j,i] = d;
j = j+1;
}
j=1
i = i+1;
}
i=1
j=1
for (c in clientes){
x1 = c$x;
y1 = c$y;
for (d in depositos){
x2 = d$x;
y2 = d$y;
distance = sqrt((x1 - x2)^2 + (y1-y2)^2);
depositosDistances[i,j] = distance;
auxiliarPlot[i, nr_clientes + j] = distance;
auxiliarPlot[nr_clientes + j,i] = distance;
j = j+1;
}
j=1
i = i+1;
}
i=1
j=1
for (d1 in depositos){
x1 = d1$x;
y1 = d1$y;
for (d2 in depositos){
x2 = d2$x;
y2 = d2$y;
distance = sqrt((x1 - x2)^2 + (y1-y2)^2);
auxiliarDepositos[i,j] = distance;
auxiliarDepositos[j,i] = distance;
auxiliarPlot[nr_clientes + i, nr_clientes + j] = distance;
auxiliarPlot[nr_clientes + j, nr_clientes + i] = distance;
j = j+1;
}
j=1
i = i+1;
}
runForAll(files[1])
for (i in 1:length(files)){
print(files[i])
runForAll(files[i])
}
for (i in 1:length(files)){
print(files[i])
runForAll(files[i])
}
for (i in 1:length(files)){
print(files[i])
runForAll(files[i])
}
print(json)
folderName = '~/Desktop/cn3/data/json/barreto_json/'
files <- list.files(folderName, full.names=TRUE)
files <- files[ grepl("\\.[json]", files) ]
print(files)
folderName = '~/Desktop/cn3/data/json/barreto_json/'
files <- list.files(folderName, full.names=TRUE)
